<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Profi - Callback —Å–µ—Ä–≤–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #2E8B32, #45B049);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #2E8B32;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #45B049;
            margin-bottom: 5px;
        }

        .logs-panel {
            background: #2d2d2d;
            border-radius: 10px;
            overflow: hidden;
        }

        .panel-header {
            background: #3d3d3d;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #4d4d4d;
        }

        .panel-header h2 {
            font-size: 18px;
            color: #45B049;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4d4d4d;
            color: white;
        }

        .btn:hover {
            background: #5d5d5d;
        }

        .logs-container {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #1a1a1a;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #2E8B32;
            background: #2d2d2d;
        }

        .log-time {
            color: #45B049;
            margin-right: 10px;
        }

        .log-data {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            color: #00ff00;
            margin-top: 8px;
            white-space: pre-wrap;
            font-size: 11px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin: 0 5px;
        }

        .badge-success { background: #2E8B32; color: white; }
        .badge-error { background: #f44336; color: white; }
        .badge-pending { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîÑ ENERGY PROFI - CALLBACK SERVER</h1>
            <div>‚ö° –ê–∫—Ç–∏–≤–Ω–∏–π</div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalCallbacks">0</div>
                <div>–í—Å—å–æ–≥–æ callback-—ñ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successCallbacks">0</div>
                <div>–£—Å–ø—ñ—à–Ω–∏—Ö</div>
            </div>
        </div>

        <div class="logs-panel">
            <div class="panel-header">
                <h2>üìã –õ–æ–≥–∏ callback-–∑–∞–ø–∏—Ç—ñ–≤</h2>
                <button class="btn" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç–∏</button>
            </div>
            <div class="logs-container" id="logsContainer">
                <div class="empty-state">‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è callback-–∑–∞–ø–∏—Ç—ñ–≤...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ============ FIREBASE –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ============
        const firebaseConfig = {
            apiKey: "AIzaSyBRXdksPhJWagfemIUq1geDQt1oYAiuPsE",
            authDomain: "energy-profi.firebaseapp.com",
            projectId: "energy-profi",
            storageBucket: "energy-profi.firebasestorage.app",
            messagingSenderId: "59748415602",
            appId: "1:59748415602:web:e204870dc80acf29d26aeb"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ============ –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü ============
        let logs = JSON.parse(localStorage.getItem('callback_logs') || '[]');

        // ============ –û–°–ù–û–í–ù–Ü –§–£–ù–ö–¶–Ü–á ============
        function detectPaymentSystem(data) {
            if (!data) return 'unknown';
            if (data.liqpay_order_id || data.signature) return 'liqpay';
            if (data.order_id && data.merchant_id) return 'fondy';
            if (data.orderReference) return 'wayforpay';
            return 'unknown';
        }

        function getPaymentStatus(data, system) {
            if (!data) return 'pending';
            
            switch(system) {
                case 'liqpay':
                    return data.status === 'success' ? 'success' : 
                           data.status === 'failure' ? 'error' : 'pending';
                case 'fondy':
                    return data.order_status === 'approved' ? 'success' : 
                           data.order_status === 'declined' ? 'error' : 'pending';
                case 'wayforpay':
                    return data.transactionStatus === 'Approved' ? 'success' : 'pending';
                default:
                    return 'success';
            }
        }

        async function updateOrderStatus(data) {
            try {
                const orderId = data.order_id || data.orderId || data.orderReference;
                if (!orderId) return;

                const ordersRef = db.collection('orders');
                const snapshot = await ordersRef.where('id', '==', parseInt(orderId)).get();
                
                if (!snapshot.empty) {
                    const orderDoc = snapshot.docs[0];
                    await orderDoc.ref.update({
                        paymentStatus: getPaymentStatus(data, detectPaymentSystem(data)),
                        callbackData: data,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error updating order:', error);
            }
        }

        function addLog(data) {
            const log = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                system: detectPaymentSystem(data),
                status: getPaymentStatus(data, detectPaymentSystem(data)),
                data: data
            };

            logs.unshift(log);
            if (logs.length > 50) logs.pop();
            
            localStorage.setItem('callback_logs', JSON.stringify(logs));
            renderLogs();
            updateStats();
        }

        function renderLogs() {
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="empty-state">‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è callback-–∑–∞–ø–∏—Ç—ñ–≤...</div>';
                return;
            }

            container.innerHTML = logs.map(log => {
                const statusClass = `badge-${log.status}`;
                return `
                <div class="log-entry">
                    <div>
                        <span class="log-time">${new Date(log.timestamp).toLocaleString()}</span>
                        <span class="badge ${statusClass}">${log.status}</span>
                        <span class="badge">${log.system}</span>
                    </div>
                    <div class="log-data">${JSON.stringify(log.data, null, 2)}</div>
                </div>
            `}).join('');
        }

        function updateStats() {
            document.getElementById('totalCallbacks').textContent = logs.length;
            document.getElementById('successCallbacks').textContent = 
                logs.filter(l => l.status === 'success').length;
        }

        function clearLogs() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –ª–æ–≥–∏?')) {
                logs = [];
                localStorage.setItem('callback_logs', '[]');
                renderLogs();
                updateStats();
            }
        }

        // ============ –û–ë–†–û–ë–ö–ê POST-–ó–ê–ü–ò–¢–Ü–í ============
        (function() {
            const originalFetch = window.fetch;
            window.fetch = async function(...args) {
                try {
                    const response = await originalFetch.apply(this, args);
                    
                    if (args[0] && args[0].includes('callback')) {
                        const data = await response.clone().json().catch(() => ({}));
                        addLog(data);
                        await updateOrderStatus(data);
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Fetch error:', error);
                    throw error;
                }
            };
        })();

        // ============ –ü–ï–†–ï–í–Ü–†–ö–ê GET-–ü–ê–†–ê–ú–ï–¢–†–Ü–í ============
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.toString()) {
            const params = {};
            for (const [key, value] of urlParams.entries()) {
                params[key] = value;
            }
            addLog(params);
            updateOrderStatus(params);
        }

        // ============ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ============
        renderLogs();
        updateStats();
    </script>
</body>
</html>
